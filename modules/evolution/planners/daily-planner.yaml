# daily-planner.yaml - ì¼ì¼ ê³„íš ìˆ˜ë¦½ê¸°
# ë§¤ì¼ ì•„ì¹¨ ì˜¤ëŠ˜ì˜ í™œë™ ê³„íš ìˆ˜ë¦½

planner:
  id: daily-planner
  name: "ì¼ì¼ ê³„íš ìˆ˜ë¦½ê¸°"
  description: "ë§¤ì¼ ì•„ì¹¨ ìƒí™© ë¶„ì„ í›„ ì˜¤ëŠ˜ì˜ í™œë™ ê³„íš ìˆ˜ë¦½"

  # === ìŠ¤ì¼€ì¤„ ===
  schedule:
    cron: "0 8 * * *"                  # ë§¤ì¼ ì˜¤ì „ 8ì‹œ
    timezone: "Asia/Seoul"
    enabled: true

  # === ì…ë ¥ ì •ë³´ ===
  inputs:
    # í˜„ì¬ ìƒíƒœ
    - id: "current_state"
      queries:
        - name: "goals_progress"
          query: |
            SELECT goal_id, name, current_value, target_value,
                   ROUND(current_value * 100.0 / target_value, 1) as progress
            FROM goals WHERE active = 1

        - name: "yesterdays_activity"
          query: |
            SELECT action_type, COUNT(*) as count
            FROM activity_log
            WHERE date(created_at) = date('now', '-1 day')
            GROUP BY action_type

        - name: "content_queue"
          query: |
            SELECT COUNT(*) as pending FROM content_queue
            WHERE status = 'pending'

        - name: "daily_limits_remaining"
          query: |
            SELECT
              ${bounds.sns.posting.max_per_day} -
                (SELECT COUNT(*) FROM posts WHERE date(posted_at) = date('now')) as posts_remaining,
              ${bounds.sns.engagement.max_likes_per_day} -
                (SELECT COUNT(*) FROM activity_log WHERE action_type = 'like' AND date(created_at) = date('now')) as likes_remaining

    # ê·œì¹™ ë° ì „ëµ
    - id: "active_rules"
      source: "state/rules.yaml"

    # ì§„í–‰ ì¤‘ì¸ ì‹¤í—˜
    - id: "running_experiments"
      source: "state/experiments.yaml"
      filter: "status == 'running'"

    # íŠ¹ë³„ ì´ë²¤íŠ¸
    - id: "special_events"
      check:
        - "holidays"
        - "trending_topics"
        - "scheduled_campaigns"

  # === ê³„íš ìˆ˜ë¦½ í”„ë¡œì„¸ìŠ¤ ===
  process:
    steps:
      # 1. ìƒí™© ë¶„ì„
      - name: "analyze_situation"
        action: "llm_analyze"
        prompt: |
          í˜„ì¬ ìƒí™©ì„ ë¶„ì„í•´ì¤˜.

          **ëª©í‘œ ì§„í–‰ ìƒí™©:**
          {goals_progress}

          **ì–´ì œ í™œë™:**
          {yesterdays_activity}

          **ì½˜í…ì¸  í:**
          ëŒ€ê¸° ì¤‘: {content_queue.pending}ê°œ

          **í™œì„± ê·œì¹™:**
          {active_rules.summary}

          **ì§„í–‰ ì¤‘ì¸ ì‹¤í—˜:**
          {running_experiments}

          ë¶„ì„ ì¶œë ¥ (JSON):
          {
            "goal_priorities": ["ìš°ì„ ìˆœìœ„ ë†’ì€ ëª©í‘œ"],
            "bottlenecks": ["ë³‘ëª© í˜„ìƒ"],
            "opportunities": ["ì˜¤ëŠ˜ì˜ ê¸°íšŒ"],
            "risks": ["ì£¼ì˜ ì‚¬í•­"]
          }
        output: "situation_analysis"

      # 2. ì˜¤ëŠ˜ì˜ ëª©í‘œ ì„¤ì •
      - name: "set_daily_goals"
        action: "determine_goals"
        based_on:
          - "${situation_analysis}"
          - "${goals_progress}"
          - "${daily_limits_remaining}"
        output: "daily_goals"

      # 3. í™œë™ ê³„íš ìˆ˜ë¦½
      - name: "plan_activities"
        action: "llm_plan"
        prompt: |
          ì˜¤ëŠ˜ì˜ í™œë™ ê³„íšì„ ìˆ˜ë¦½í•´ì¤˜.

          **ìƒí™© ë¶„ì„:**
          {situation_analysis}

          **ì˜¤ëŠ˜ ëª©í‘œ:**
          {daily_goals}

          **ë‚¨ì€ í•œë„:**
          {daily_limits_remaining}

          **í™œì„± ê·œì¹™ (timing):**
          ìµœì  ì‹œê°„: {active_rules.timing.best_hours}
          í”¼í•  ì‹œê°„: {active_rules.timing.avoid_hours}

          ê³„íš ì¶œë ¥ í˜•ì‹ (JSON):
          {
            "posting_plan": {
              "count": 2,
              "times": ["14:00", "19:00"],
              "content_ids": [1, 2]
            },
            "engagement_plan": {
              "likes_target": 30,
              "follows_target": 10,
              "replies_target": 5,
              "focus_time": "10:00-12:00"
            },
            "research_plan": {
              "topics": ["AI trends", "automation"],
              "time": "09:00-10:00"
            },
            "experiment_tasks": [
              "ì‹¤í—˜ X ë°ì´í„° ìˆ˜ì§‘"
            ],
            "special_tasks": []
          }
        output: "activity_plan"

      # 4. ìš°ì„ ìˆœìœ„ ì •ë ¬
      - name: "prioritize"
        action: "rank_tasks"
        criteria:
          - factor: "goal_impact"
            weight: 0.4
          - factor: "deadline"
            weight: 0.3
          - factor: "effort"
            weight: 0.2
          - factor: "opportunity_window"
            weight: 0.1
        output: "prioritized_plan"

      # 5. ì¼ì • ìµœì í™”
      - name: "optimize_schedule"
        action: "schedule_tasks"
        constraints:
          - "respect_timing_rules"
          - "avoid_conflicts"
          - "batch_similar_tasks"
        output: "optimized_schedule"

  # === ì¶œë ¥ ===
  output:
    # ì¼ì¼ ê³„íš ë¬¸ì„œ
    plan_document:
      path: "memory/daily/${date}-plan.md"
      template: |
        # ğŸ“… ì¼ì¼ ê³„íš: {date}

        > ìƒì„±: {timestamp}

        ## ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ

        {daily_goals_list}

        ## ğŸ“Š í˜„ì¬ ìƒí™©

        ### ëª©í‘œ ì§„í–‰ë¥ 
        {goals_progress_table}

        ### ì–´ì œ í™œë™ ìš”ì•½
        {yesterday_summary}

        ## ğŸ“‹ ì˜¤ëŠ˜ì˜ ê³„íš

        ### â° ì‹œê°„ëŒ€ë³„ ì¼ì •

        {schedule_timeline}

        ### ğŸ“ í¬ìŠ¤íŒ… ê³„íš
        - ì˜ˆì • í¬ìŠ¤íŠ¸: {posting_plan.count}ê°œ
        - ì‹œê°„: {posting_plan.times}
        - ì½˜í…ì¸ : {posting_plan.content_preview}

        ### ğŸ’¬ ì¸ê²Œì´ì§€ë¨¼íŠ¸ ê³„íš
        - ì¢‹ì•„ìš”: {engagement_plan.likes_target}
        - íŒ”ë¡œìš°: {engagement_plan.follows_target}
        - ë‹µê¸€: {engagement_plan.replies_target}
        - ì§‘ì¤‘ ì‹œê°„: {engagement_plan.focus_time}

        ### ğŸ”¬ ì‹¤í—˜ íƒœìŠ¤í¬
        {experiment_tasks}

        ## âš ï¸ ì£¼ì˜ ì‚¬í•­

        {risks_and_notes}

        ---
        *ì´ ê³„íšì€ ìƒí™©ì— ë”°ë¼ ì¡°ì •ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.*

    # ì‹¤í–‰ ê°€ëŠ¥í•œ íƒœìŠ¤í¬
    executable_tasks:
      path: "data/today_tasks.json"
      format: |
        {
          "date": "{date}",
          "tasks": [
            {
              "id": "task_1",
              "type": "post",
              "scheduled_time": "14:00",
              "params": {...},
              "status": "pending"
            }
          ]
        }

    # ì•Œë¦¼
    notification:
      channel: "telegram"
      send_at: "08:00"
      message: |
        â˜€ï¸ **ì˜¤ëŠ˜ì˜ ê³„íš**

        ğŸ“… {date}

        ğŸ¯ **ëª©í‘œ**
        {daily_goals_brief}

        ğŸ“‹ **ì£¼ìš” ê³„íš**
        - í¬ìŠ¤íŒ…: {posting_plan.count}ê°œ ({posting_plan.times})
        - ì¸ê²Œì´ì§€ë¨¼íŠ¸: ì¢‹ì•„ìš” {likes}, íŒ”ë¡œìš° {follows}

        {special_notes}

        ìì„¸í•œ ê³„íš: memory/daily/{date}-plan.md

  # === ê³„íš ì‹¤í–‰ ì¶”ì  ===
  execution_tracking:
    # ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ì¶”ì 
    track_completion: true

    # ì €ë… íšŒê³ 
    evening_review:
      schedule: "0 22 * * *"           # ì €ë… 10ì‹œ
      generate_report: true

  # === ë¡œê¹… ===
  logging:
    log_plans: true
    log_path: "data/planning_log.json"
