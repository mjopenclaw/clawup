# metrics-analyzer.yaml - ë©”íŠ¸ë¦­ ë¶„ì„ê¸°
# ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ì„ ë¶„ì„í•˜ì—¬ íŒ¨í„´ê³¼ ì¸ì‚¬ì´íŠ¸ ë„ì¶œ

analyzer:
  id: metrics-analyzer
  name: "ë©”íŠ¸ë¦­ ë¶„ì„ê¸°"
  description: "í™œë™ ë©”íŠ¸ë¦­ì„ ë¶„ì„í•˜ì—¬ íŒ¨í„´ ë°œê²¬ ë° ê·œì¹™ ê°œì„  ì œì•ˆ"

  # === ìŠ¤ì¼€ì¤„ ===
  schedule:
    cron: "0 23 * * *"                 # ë§¤ì¼ ë°¤ 11ì‹œ
    timezone: "Asia/Seoul"
    enabled: true

  # === ë¶„ì„ ëŒ€ìƒ ===
  data_sources:
    # í¬ìŠ¤íŠ¸ ì„±ê³¼
    - id: "post_performance"
      name: "í¬ìŠ¤íŠ¸ ì„±ê³¼"
      query: |
        SELECT
          p.id,
          p.platform,
          p.content,
          p.posted_at,
          strftime('%H', p.posted_at) as post_hour,
          strftime('%w', p.posted_at) as post_day,
          pa.likes,
          pa.reposts,
          pa.views,
          pa.engagement_rate,
          p.hashtag_count,
          length(p.content) as content_length
        FROM posts p
        LEFT JOIN post_analytics pa ON p.id = pa.post_id
        WHERE p.posted_at > date('now', '-30 days')
        ORDER BY p.posted_at DESC

    # ì¸ê²Œì´ì§€ë¨¼íŠ¸ í™œë™
    - id: "engagement_activity"
      name: "ì¸ê²Œì´ì§€ë¨¼íŠ¸ í™œë™"
      query: |
        SELECT
          action_type,
          platform,
          date(created_at) as date,
          strftime('%H', created_at) as hour,
          COUNT(*) as count
        FROM activity_log
        WHERE created_at > date('now', '-30 days')
        GROUP BY action_type, platform, date, hour

    # íŒ”ë¡œì›Œ ì„±ì¥
    - id: "follower_growth"
      name: "íŒ”ë¡œì›Œ ì„±ì¥"
      query: |
        SELECT
          date,
          x_followers,
          threads_followers,
          x_followers - LAG(x_followers) OVER (ORDER BY date) as x_delta,
          threads_followers - LAG(threads_followers) OVER (ORDER BY date) as threads_delta
        FROM daily_stats
        WHERE date > date('now', '-30 days')
        ORDER BY date

  # === ë¶„ì„ ìœ í˜• ===
  analyses:
    # 1. ì‹œê°„ëŒ€ ë¶„ì„
    - id: "timing_analysis"
      name: "í¬ìŠ¤íŒ… ì‹œê°„ëŒ€ ë¶„ì„"
      description: "ì–´ë–¤ ì‹œê°„ëŒ€ í¬ìŠ¤íŒ…ì´ ì„±ê³¼ê°€ ì¢‹ì€ì§€ ë¶„ì„"

      method: |
        1. ì‹œê°„ëŒ€ë³„ í‰ê·  engagement_rate ê³„ì‚°
        2. ìš”ì¼ë³„ í‰ê·  engagement_rate ê³„ì‚°
        3. ì‹œê°„ëŒ€ x ìš”ì¼ ì¡°í•© ë¶„ì„
        4. ìµœì  ì‹œê°„ëŒ€ ë„ì¶œ

      output:
        - metric: "best_hours"
          description: "ìµœê³  ì„±ê³¼ ì‹œê°„ëŒ€"
        - metric: "avoid_hours"
          description: "í”¼í•´ì•¼ í•  ì‹œê°„ëŒ€"
        - metric: "best_days"
          description: "ìµœê³  ì„±ê³¼ ìš”ì¼"

      rule_suggestion:
        target: "state/rules.yaml"
        path: "timing"

    # 2. ì½˜í…ì¸  ë¶„ì„
    - id: "content_analysis"
      name: "ì½˜í…ì¸  ë¶„ì„"
      description: "ì–´ë–¤ ìœ í˜•ì˜ ì½˜í…ì¸ ê°€ ì„±ê³¼ê°€ ì¢‹ì€ì§€ ë¶„ì„"

      method: |
        1. ì½˜í…ì¸  ê¸¸ì´ë³„ ì„±ê³¼ ë¶„ì„
        2. í•´ì‹œíƒœê·¸ ìˆ˜ë³„ ì„±ê³¼ ë¶„ì„
        3. ì£¼ì œë³„ ì„±ê³¼ ë¶„ì„ (LLM ë¶„ë¥˜)
        4. íŒ¨í„´ ë„ì¶œ

      output:
        - metric: "optimal_length"
          description: "ìµœì  ì½˜í…ì¸  ê¸¸ì´"
        - metric: "optimal_hashtags"
          description: "ìµœì  í•´ì‹œíƒœê·¸ ìˆ˜"
        - metric: "top_topics"
          description: "ì„±ê³¼ ì¢‹ì€ ì£¼ì œ"

      rule_suggestion:
        target: "state/rules.yaml"
        path: "content"

    # 3. ì¸ê²Œì´ì§€ë¨¼íŠ¸ ë¶„ì„
    - id: "engagement_analysis"
      name: "ì¸ê²Œì´ì§€ë¨¼íŠ¸ ë¶„ì„"
      description: "ì¸ê²Œì´ì§€ë¨¼íŠ¸ í™œë™ì˜ íš¨ê³¼ ë¶„ì„"

      method: |
        1. ì•¡ì…˜ë³„ íŒ”ë¡œì›Œ íšë“ ìƒê´€ê´€ê³„
        2. ëŒ“ê¸€ â†’ íŒ”ë¡œìš° ì „í™˜ìœ¨
        3. ë§íŒ”ë¡œìš° ìœ ì§€ìœ¨
        4. ìµœì  ì¸ê²Œì´ì§€ë¨¼íŠ¸ ì „ëµ ë„ì¶œ

      output:
        - metric: "best_engagement_actions"
          description: "íš¨ê³¼ì ì¸ ì¸ê²Œì´ì§€ë¨¼íŠ¸ ì•¡ì…˜"
        - metric: "follow_back_retention"
          description: "ë§íŒ”ë¡œìš° ìœ ì§€ìœ¨"

      rule_suggestion:
        target: "state/rules.yaml"
        path: "engagement"

    # 4. ì„±ì¥ ì¶”ì„¸ ë¶„ì„
    - id: "growth_analysis"
      name: "ì„±ì¥ ì¶”ì„¸ ë¶„ì„"
      description: "íŒ”ë¡œì›Œ ì„±ì¥ ì¶”ì„¸ ë° ì˜ˆì¸¡"

      method: |
        1. ì¼ë³„ ì„±ì¥ë¥  ê³„ì‚°
        2. ì£¼ë³„ íŠ¸ë Œë“œ ë¶„ì„
        3. ì„±ì¥ì— ì˜í–¥ ì¤€ ìš”ì¸ ë¶„ì„
        4. ëª©í‘œ ë‹¬ì„± ì˜ˆì¸¡

      output:
        - metric: "avg_daily_growth"
          description: "í‰ê·  ì¼ì¼ ì„±ì¥"
        - metric: "growth_trend"
          description: "ì„±ì¥ ì¶”ì„¸ (ìƒìŠ¹/í•˜ë½/ì •ì²´)"
        - metric: "goal_eta"
          description: "ëª©í‘œ ë‹¬ì„± ì˜ˆìƒì¼"

  # === ê·œì¹™ ì—…ë°ì´íŠ¸ ===
  rule_updates:
    auto_apply:
      enabled: true
      confidence_threshold: 0.7        # bounds.yaml ì°¸ì¡°

    approval_required:
      threshold: 0.9
      channel: "telegram"

    process:
      - step: "calculate_confidence"
        method: |
          confidence = (sample_size / min_sample) * (effect_size / min_effect) * statistical_significance
          confidence = min(confidence, 1.0)

      - step: "validate_within_bounds"
        check: "bounds.yaml"

      - step: "apply_or_propose"
        condition: |
          if confidence >= auto_apply_threshold:
            auto_apply()
          elif confidence >= proposal_threshold:
            request_approval()
          else:
            log_for_more_data()

  # === ì¶œë ¥ ===
  output:
    # ë¶„ì„ ë³´ê³ ì„œ
    report:
      path: "memory/analysis/${date}-metrics.md"
      template: |
        # ğŸ“Š ì¼ì¼ ë©”íŠ¸ë¦­ ë¶„ì„

        > ë¶„ì„ ì¼ì‹œ: {timestamp}
        > ë¶„ì„ ê¸°ê°„: ìµœê·¼ 30ì¼

        ## ğŸ• ì‹œê°„ëŒ€ ë¶„ì„

        ### ìµœì  í¬ìŠ¤íŒ… ì‹œê°„
        {best_hours_chart}

        ### ìš”ì¼ë³„ ì„±ê³¼
        {day_performance}

        ## ğŸ“ ì½˜í…ì¸  ë¶„ì„

        ### ê¸¸ì´ë³„ ì„±ê³¼
        {length_analysis}

        ### í•´ì‹œíƒœê·¸ íš¨ê³¼
        {hashtag_analysis}

        ## ğŸ“ˆ ì„±ì¥ ë¶„ì„

        {growth_chart}

        - í‰ê·  ì¼ì¼ ì„±ì¥: {avg_daily_growth}
        - ì¶”ì„¸: {growth_trend}
        - ëª©í‘œ ë‹¬ì„± ì˜ˆìƒ: {goal_eta}

        ## ğŸ¯ ê·œì¹™ ì—…ë°ì´íŠ¸ ì œì•ˆ

        {rule_suggestions}

        ## ğŸ’¡ ì¸ì‚¬ì´íŠ¸

        {key_insights}

    # ê·œì¹™ ì—…ë°ì´íŠ¸
    rules_update:
      path: "state/rules.yaml"
      backup_before_update: true

    # ì•Œë¦¼
    notification:
      channel: "telegram"
      send_if: "has_significant_insights OR rule_updates_proposed"

  # === ë¡œê¹… ===
  logging:
    log_analyses: true
    log_path: "data/metrics_analysis_log.json"
