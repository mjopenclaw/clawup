# pattern-detector.yaml - íŒ¨í„´ ê°ì§€ê¸°
# ë°ì´í„°ì—ì„œ ìë™ìœ¼ë¡œ íŒ¨í„´ì„ ê°ì§€í•˜ê³  ê·œì¹™ í›„ë³´ ìƒì„±

detector:
  id: pattern-detector
  name: "íŒ¨í„´ ê°ì§€ê¸°"
  description: "í™œë™ ë°ì´í„°ì—ì„œ ìë™ìœ¼ë¡œ íŒ¨í„´ì„ ê°ì§€í•˜ì—¬ ê·œì¹™ í›„ë³´ ìƒì„±"

  # === ìŠ¤ì¼€ì¤„ ===
  schedule:
    cron: "0 4 * * 0"                  # ë§¤ì£¼ ì¼ìš”ì¼ ìƒˆë²½ 4ì‹œ
    timezone: "Asia/Seoul"
    enabled: true

  # === íŒ¨í„´ ìœ í˜• ===
  pattern_types:
    # 1. ì‹œê³„ì—´ íŒ¨í„´
    - type: "time_series"
      name: "ì‹œê³„ì—´ íŒ¨í„´"
      detects:
        - "ì£¼ê¸°ì  ë³€ë™"
        - "ì¶”ì„¸"
        - "ì´ìƒì¹˜"
        - "ê³„ì ˆì„±"

      methods:
        - name: "trend_detection"
          description: "ìƒìŠ¹/í•˜ë½ ì¶”ì„¸ ê°ì§€"
          algorithm: "linear_regression"
          min_data_points: 14

        - name: "periodicity"
          description: "ì£¼ê¸°ì  íŒ¨í„´ ê°ì§€"
          algorithm: "autocorrelation"
          check_periods: [7, 14, 30]    # ì¼, ì£¼, ì›” ë‹¨ìœ„

        - name: "anomaly"
          description: "ì´ìƒì¹˜ ê°ì§€"
          algorithm: "z_score"
          threshold: 2.5

    # 2. ìƒê´€ê´€ê³„ íŒ¨í„´
    - type: "correlation"
      name: "ìƒê´€ê´€ê³„ íŒ¨í„´"
      detects:
        - "ë³€ìˆ˜ ê°„ ìƒê´€ê´€ê³„"
        - "ì¸ê³¼ ê´€ê³„ í›„ë³´"

      methods:
        - name: "correlation_matrix"
          description: "ë³€ìˆ˜ ê°„ ìƒê´€ê´€ê³„"
          algorithm: "pearson"
          min_correlation: 0.5

        - name: "lagged_correlation"
          description: "ì‹œì°¨ ìƒê´€ê´€ê³„"
          lags: [1, 3, 7]              # 1ì¼, 3ì¼, 7ì¼ í›„

    # 3. í´ëŸ¬ìŠ¤í„°ë§ íŒ¨í„´
    - type: "clustering"
      name: "í´ëŸ¬ìŠ¤í„°ë§"
      detects:
        - "ìœ ì‚¬í•œ í¬ìŠ¤íŠ¸ ê·¸ë£¹"
        - "ì„±ê³¼ ê·¸ë£¹"

      methods:
        - name: "performance_clusters"
          description: "ì„±ê³¼ë³„ í¬ìŠ¤íŠ¸ í´ëŸ¬ìŠ¤í„°ë§"
          algorithm: "kmeans"
          n_clusters: 3                 # ì €ì„±ê³¼, ì¤‘ì„±ê³¼, ê³ ì„±ê³¼

    # 4. ê·œì¹™ íŒ¨í„´ (If-Then)
    - type: "rule_patterns"
      name: "ì¡°ê±´ë¶€ íŒ¨í„´"
      detects:
        - "íŠ¹ì • ì¡°ê±´ â†’ íŠ¹ì • ê²°ê³¼"

      methods:
        - name: "association_rules"
          description: "ì—°ê´€ ê·œì¹™ ë§ˆì´ë‹"
          min_support: 0.1
          min_confidence: 0.7

  # === ê°ì§€ í”„ë¡œì„¸ìŠ¤ ===
  process:
    steps:
      # 1. ë°ì´í„° ì¤€ë¹„
      - name: "prepare_data"
        action: "query_and_clean"
        queries:
          - "${analyzer.metrics-analyzer.data_sources}"
        output: "clean_data"

      # 2. íŒ¨í„´ ê°ì§€
      - name: "detect_patterns"
        for_each: "pattern_type in pattern_types"
        action: "run_detection"
        output: "detected_patterns"

      # 3. íŒ¨í„´ ê²€ì¦
      - name: "validate_patterns"
        action: "statistical_validation"
        tests:
          - "chi_square"
          - "t_test"
          - "bootstrap"
        min_significance: 0.95
        output: "validated_patterns"

      # 4. ê·œì¹™ í›„ë³´ ìƒì„±
      - name: "generate_rule_candidates"
        action: "pattern_to_rule"
        input: "${validated_patterns}"
        output: "rule_candidates"

      # 5. ì‹¤í—˜ ì œì•ˆ
      - name: "propose_experiments"
        action: "create_experiments"
        input: "${rule_candidates}"
        output: "experiment_proposals"

  # === ê·œì¹™ í›„ë³´ ìƒì„± ===
  rule_generation:
    template:
      id: "rule_{pattern_id}_{timestamp}"
      pattern_type: "{pattern_type}"
      condition: "{condition}"
      action: "{action}"
      confidence: "{calculated_confidence}"
      sample_size: "{n_observations}"
      statistical_significance: "{p_value}"
      effect_size: "{effect_size}"
      status: "candidate"
      created_at: "{timestamp}"
      source: "pattern_detector"

    # ì‹ ë¢°ë„ ê³„ì‚°
    confidence_calculation: |
      base_confidence = (1 - p_value) * (sample_size / 30)
      effect_bonus = effect_size * 0.2
      confidence = min(base_confidence + effect_bonus, 0.95)

  # === ì‹¤í—˜ ì œì•ˆ ===
  experiment_proposal:
    # ê·œì¹™ í›„ë³´ â†’ ì‹¤í—˜ ë³€í™˜
    template:
      id: "exp_{rule_id}"
      hypothesis: "{rule_condition} â†’ {rule_action} íš¨ê³¼ ê²€ì¦"
      variable: "{rule_variable}"
      control: "í˜„ì¬ í–‰ë™"
      treatment: "{rule_suggested_change}"
      duration_days: 7
      min_samples: 10
      success_metric: "{affected_metric}"
      status: "proposed"

    # ìë™ ì‹œì‘ ì¡°ê±´
    auto_start:
      enabled: true
      conditions:
        - "confidence >= 0.5"
        - "estimated_impact >= 'medium'"
        - "no_conflicting_experiments"

  # === ì¶œë ¥ ===
  output:
    # ê°ì§€ ë³´ê³ ì„œ
    report:
      path: "memory/patterns/${date}-patterns.md"
      template: |
        # ğŸ” íŒ¨í„´ ê°ì§€ ë³´ê³ ì„œ

        > ë¶„ì„ ì¼ì‹œ: {timestamp}

        ## ë°œê²¬ëœ íŒ¨í„´

        ### ì‹œê³„ì—´ íŒ¨í„´
        {time_series_patterns}

        ### ìƒê´€ê´€ê³„
        {correlations}

        ### ê·œì¹™ íŒ¨í„´
        {rule_patterns}

        ## ğŸ“‹ ê·œì¹™ í›„ë³´

        {rule_candidates_table}

        ## ğŸ§ª ì‹¤í—˜ ì œì•ˆ

        {experiment_proposals}

        ## ğŸ“Š í†µê³„ ìš”ì•½

        - ê²€ì¦ëœ íŒ¨í„´: {validated_count}
        - ìƒì„±ëœ ê·œì¹™ í›„ë³´: {rule_count}
        - ì œì•ˆëœ ì‹¤í—˜: {experiment_count}

    # ê·œì¹™ í›„ë³´ ì €ì¥
    rule_candidates:
      path: "state/rules.yaml"
      section: "pending_rules"

    # ì‹¤í—˜ ì œì•ˆ ì €ì¥
    experiments:
      path: "state/experiments.yaml"
      section: "pending"

    # ì•Œë¦¼
    notification:
      channel: "telegram"
      send_if: "rule_candidates.length > 0"
      message: |
        ğŸ” **íŒ¨í„´ ê°ì§€ ì™„ë£Œ**

        ë°œê²¬ëœ íŒ¨í„´: {pattern_count}ê°œ
        ê·œì¹™ í›„ë³´: {rule_count}ê°œ
        ì‹¤í—˜ ì œì•ˆ: {experiment_count}ê°œ

        ìì„¸í•œ ë‚´ìš©ì€ ë³´ê³ ì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.

  # === ë¡œê¹… ===
  logging:
    log_detections: true
    log_path: "data/pattern_detection_log.json"
