# docs-learner.yaml - ë¬¸ì„œ ê¸°ë°˜ ìê°€ í•™ìŠµê¸°
# openclaw-docsë¥¼ ì½ê³  ìƒˆ ê¸°ëŠ¥ì„ ìŠ¤ìŠ¤ë¡œ ìƒì„±

learner:
  id: docs-learner
  name: "ë¬¸ì„œ ê¸°ë°˜ í•™ìŠµê¸°"
  description: "openclaw-docsë¥¼ ì°¸ì¡°í•˜ì—¬ ìƒˆë¡œìš´ ê¸°ëŠ¥ì„ í•™ìŠµí•˜ê³  ìƒì„±"

  # === íŠ¸ë¦¬ê±° ===
  triggers:
    # ìˆ˜ë™ íŠ¸ë¦¬ê±° (ì‚¬ìš©ì ìš”ì²­)
    - type: "user_request"
      patterns:
        - "ìƒˆ ì±„ë„ ì¶”ê°€"
        - "ìƒˆ ì•¡ì…˜ êµ¬í˜„"
        - "{feature} ê¸°ëŠ¥ ì¶”ê°€"
        - "{channel} ì—°ë™"

    # ìë™ íŠ¸ë¦¬ê±° (í•„ìš” ê°ì§€)
    - type: "auto_detect"
      conditions:
        - "error_pattern_repeated > 3"
        - "missing_feature_mentioned"
        - "user_asked_for_capability"

  # === ë¬¸ì„œ ê²½ë¡œ ===
  docs_paths:
    primary:
      - ".openclaw-template/openclaw-docs/tools/"
      - ".openclaw-template/openclaw-docs/automation/"
      - ".openclaw-template/openclaw-docs/cli/"

    secondary:
      - ".openclaw-template/openclaw-docs/concepts/"
      - ".openclaw-template/openclaw-docs/reference/"
      - ".openclaw-template/openclaw-docs/gateway/"

    examples:
      - "modules/sns/channels/"        # ê¸°ì¡´ êµ¬í˜„ ì°¸ì¡°
      - "modules/sns/actions/"
      - "modules/shared/"

  # === í•™ìŠµ í”„ë¡œì„¸ìŠ¤ ===
  process:
    # --- Phase 1: í•„ìš” ì‹ë³„ ---
    - step: "identify_need"
      name: "í•„ìš” ì‹ë³„"
      description: "ë¬´ì—‡ì´ í•„ìš”í•œì§€ ëª…í™•íˆ ì •ì˜"

      actions:
        - action: "analyze_request"
          prompt: |
            ë‹¤ìŒ ìš”ì²­ì„ ë¶„ì„í•´ì¤˜:
            {user_request}

            ì¶œë ¥ í˜•ì‹ (JSON):
            {
              "feature_type": "channel | action | pipeline | service",
              "feature_name": "êµ¬ì²´ì  ê¸°ëŠ¥ëª…",
              "requirements": ["ìš”êµ¬ì‚¬í•­ 1", "ìš”êµ¬ì‚¬í•­ 2"],
              "similar_existing": ["ìœ ì‚¬í•œ ê¸°ì¡´ ê¸°ëŠ¥"],
              "estimated_complexity": "low | medium | high"
            }
          output: "need_analysis"

    # --- Phase 2: ë¬¸ì„œ ê²€ìƒ‰ ---
    - step: "search_docs"
      name: "ë¬¸ì„œ ê²€ìƒ‰"
      description: "ê´€ë ¨ OpenClaw ë¬¸ì„œ ê²€ìƒ‰"

      actions:
        - action: "search_files"
          paths: "${docs_paths.primary}"
          keywords: "${need_analysis.requirements}"
          output: "relevant_docs"

        - action: "read_docs"
          files: "${relevant_docs}"
          output: "doc_contents"

    # --- Phase 3: ê¸°ì¡´ êµ¬í˜„ ë¶„ì„ ---
    - step: "analyze_existing"
      name: "ê¸°ì¡´ êµ¬í˜„ ë¶„ì„"
      description: "ìœ ì‚¬í•œ ê¸°ì¡´ êµ¬í˜„ ë¶„ì„"

      actions:
        - action: "find_similar"
          search_in: "${docs_paths.examples}"
          similar_to: "${need_analysis.feature_type}"
          output: "similar_implementations"

        - action: "extract_patterns"
          input: "${similar_implementations}"
          output: "implementation_patterns"

    # --- Phase 4: êµ¬í˜„ ê³„íš ìƒì„± ---
    - step: "synthesize"
      name: "êµ¬í˜„ ê³„íš ìƒì„±"
      description: "ë¬¸ì„œì™€ íŒ¨í„´ ê¸°ë°˜ìœ¼ë¡œ êµ¬í˜„ ê³„íš ì‘ì„±"

      actions:
        - action: "generate_plan"
          prompt: |
            ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ êµ¬í˜„ ê³„íšì„ ì‘ì„±í•´ì¤˜.

            **ìš”êµ¬ì‚¬í•­:**
            {need_analysis}

            **ê´€ë ¨ ë¬¸ì„œ:**
            {doc_contents}

            **ê¸°ì¡´ êµ¬í˜„ íŒ¨í„´:**
            {implementation_patterns}

            **êµ¬í˜„ ê³„íš ì¶œë ¥ í˜•ì‹:**
            # {feature_name} êµ¬í˜„ ê³„íš

            ## ê°œìš”
            - ëª©ì :
            - ìœ í˜•: {feature_type}

            ## í•„ìš”í•œ íŒŒì¼
            1. {file_path}: {ì„¤ëª…}
            2. ...

            ## êµ¬í˜„ ë‹¨ê³„
            1. {ë‹¨ê³„ 1}
            2. {ë‹¨ê³„ 2}

            ## ì°¸ì¡° ë¬¸ì„œ
            - {doc_reference}

            ## í…ŒìŠ¤íŠ¸ ê³„íš
            - {test_1}

          output: "implementation_plan"

        - action: "save_plan"
          content: "${implementation_plan}"
          path: "memory/plans/${need_analysis.feature_name}-plan.md"

    # --- Phase 5: êµ¬í˜„ (ìŠ¹ì¸ í›„) ---
    - step: "implement"
      name: "êµ¬í˜„"
      description: "ê³„íšì— ë”°ë¼ ì½”ë“œ/ì„¤ì • ìƒì„±"
      approval_required: true

      actions:
        - action: "request_approval"
          channel: "telegram"
          message: |
            ğŸ”§ **ìƒˆ ê¸°ëŠ¥ êµ¬í˜„ ìŠ¹ì¸ ìš”ì²­**

            **ê¸°ëŠ¥**: ${need_analysis.feature_name}
            **ìœ í˜•**: ${need_analysis.feature_type}
            **ë³µì¡ë„**: ${need_analysis.estimated_complexity}

            **ê³„íš ìš”ì•½**:
            ${implementation_plan.summary}

            âœ… /approve-impl ${request_id}
            âŒ /reject-impl ${request_id}

        - action: "on_approve"
          steps:
            - generate_files:
                based_on: "${implementation_plan}"
            - validate_syntax:
                files: "${generated_files}"
            - save_files:
                files: "${generated_files}"

    # --- Phase 6: í…ŒìŠ¤íŠ¸ ---
    - step: "test"
      name: "í…ŒìŠ¤íŠ¸"
      description: "ìƒì„±ëœ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸"

      actions:
        - action: "run_tests"
          test_plan: "${implementation_plan.test_plan}"
          output: "test_results"

        - action: "validate_results"
          input: "${test_results}"
          on_fail:
            action: "fix_and_retry"
            max_retries: 3

    # --- Phase 7: í†µí•© ---
    - step: "integrate"
      name: "í†µí•©"
      description: "ì„±ê³µ ì‹œ ëª¨ë“ˆì— í†µí•©"

      actions:
        - action: "update_registry"
          feature: "${need_analysis}"

        - action: "update_docs"
          add_to: "memory/learnings/${date}-${feature_name}.md"

        - action: "notify_success"
          channel: "telegram"
          message: |
            âœ… **ìƒˆ ê¸°ëŠ¥ ì¶”ê°€ ì™„ë£Œ**

            **ê¸°ëŠ¥**: ${need_analysis.feature_name}
            **íŒŒì¼**: ${generated_files}

            ì‚¬ìš© ë°©ë²•ì€ ê³„íš ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

  # === í•™ìŠµ ê¸°ë¡ ===
  learning_log:
    enabled: true
    path: "memory/learnings/"

    template: |
      # í•™ìŠµ ê¸°ë¡: {feature_name}

      ## ì¼ì‹œ
      {timestamp}

      ## ìš”ì²­
      {original_request}

      ## ì°¸ì¡° ë¬¸ì„œ
      {referenced_docs}

      ## ìƒì„±ëœ íŒŒì¼
      {generated_files}

      ## í•™ìŠµëœ íŒ¨í„´
      {patterns_learned}

      ## í–¥í›„ ê°œì„ ì 
      {improvements}

  # === ì•ˆì „ ì„¤ì • ===
  safety:
    # ìˆ˜ì • ë¶ˆê°€ ì˜ì—­
    forbidden_paths:
      - "config/bounds.yaml"
      - "core/**"

    # ìŠ¹ì¸ í•„ìš” ì¡°ê±´
    require_approval:
      - "any_file_creation"
      - "any_file_modification"

    # ë¡¤ë°± ì§€ì›
    rollback:
      enabled: true
      keep_backups: true
      backup_path: "data/backups/"

  # === ë¡œê¹… ===
  logging:
    log_learning: true
    log_path: "data/learning_log.json"
