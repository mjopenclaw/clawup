# similarity.yaml - 유사도 검증기
# 과거 포스트와의 유사도를 검사하여 중복 콘텐츠 방지

validator:
  id: similarity-check
  name: "유사도 검사"
  description: "과거 포스트와 유사도 검사하여 중복 방지"

  # === 검사 방법 ===
  method: "tfidf_cosine"              # tfidf_cosine | jaccard | levenshtein | llm
  threshold: 0.6                       # 60% 이상 유사하면 차단

  # === 비교 대상 ===
  compare_against:
    - source: "db"
      query: |
        SELECT content FROM posts
        WHERE platform = '{platform}'
        ORDER BY created_at DESC
        LIMIT 100
      weight: 1.0

    - source: "db"
      query: |
        SELECT content FROM posts
        WHERE platform = '{platform}'
        AND date(created_at) = date('now', '-1 day')
      weight: 1.5                      # 어제 포스트와 더 엄격하게 비교

  # === 유사도 감지 시 동작 ===
  on_similar:
    action: "block"                    # block | warn | log
    message: "⚠️ 유사한 포스트 감지: {similarity}% 유사\n원본: {similar_post_preview}"

    # 대안 제시
    alternatives:
      - id: "rephrase"
        name: "다시 작성"
        action: "llm_rephrase"
        prompt: |
          다음 콘텐츠를 완전히 다른 관점/표현으로 재작성해줘.
          기존 콘텐츠: {original}
          유사한 기존 포스트: {similar_post}

          주의: 같은 정보를 전달하되, 표현과 구조를 완전히 다르게

      - id: "skip"
        name: "건너뛰기"
        action: "skip_to_next"

      - id: "force"
        name: "강제 포스팅"
        action: "bypass"
        require_approval: true         # 승인 필요

  # === 제외 조건 ===
  exclude:
    # 이 조건에 해당하면 유사도 검사 스킵
    - condition: "content_type == 'repost'"
      reason: "리포스트는 유사도 검사 불필요"

    - condition: "is_reply == true"
      reason: "답글은 컨텍스트에 따라 유사할 수 있음"

  # === 세부 설정 ===
  settings:
    # 텍스트 전처리
    preprocessing:
      lowercase: true
      remove_urls: true
      remove_mentions: true
      remove_hashtags: true
      remove_emoji: false

    # 유사도 계산 가중치
    weights:
      title_similarity: 0.3
      content_similarity: 0.7

    # 캐싱
    cache:
      enabled: true
      ttl_minutes: 60

  # === 로깅 ===
  logging:
    log_checks: true
    log_path: "data/similarity_log.json"
    include_similar_posts: true
