# activity.yaml - í™œë™ ëŒ€ì‹œë³´ë“œ
# í™œë™ í˜„í™© ëŒ€ì‹œë³´ë“œ ìë™ ìƒì„±

dashboard:
  id: activity-dashboard
  name: "í™œë™ ëŒ€ì‹œë³´ë“œ"
  description: "SNS í™œë™ í˜„í™© ë° ì„±ì¥ ì§€í‘œ ëŒ€ì‹œë³´ë“œ"

  # === ì¶œë ¥ ì„¤ì • ===
  output:
    - type: "markdown"
      path: "memory/dashboard.md"
      auto_update: true

    - type: "html"
      path: "data/dashboard.html"

    - type: "telegram"
      send_to: "${config.telegram.monitor.chat_id}"
      schedule: "0 9 * * *"           # ë§¤ì¼ ì•„ì¹¨ 9ì‹œ

  # === ì„¹ì…˜ ì •ì˜ ===
  sections:
    # --- ì˜¤ëŠ˜ í™œë™ ---
    - name: "ì˜¤ëŠ˜ í™œë™"
      id: "today_activity"
      query: |
        SELECT
          COUNT(*) as total,
          SUM(CASE WHEN action_type='post' THEN 1 ELSE 0 END) as posts,
          SUM(CASE WHEN action_type='like' THEN 1 ELSE 0 END) as likes,
          SUM(CASE WHEN action_type='follow' THEN 1 ELSE 0 END) as follows,
          SUM(CASE WHEN action_type='reply' THEN 1 ELSE 0 END) as replies,
          SUM(CASE WHEN action_type='repost' THEN 1 ELSE 0 END) as reposts
        FROM activity_log
        WHERE date(created_at) = date('now')
      format: "summary"

    # --- ì„±ì¥ ì§€í‘œ ---
    - name: "ì„±ì¥ ì§€í‘œ (7ì¼)"
      id: "growth_metrics"
      query: |
        SELECT
          date,
          x_followers,
          threads_followers,
          (x_followers - LAG(x_followers) OVER (ORDER BY date)) as x_delta,
          (threads_followers - LAG(threads_followers) OVER (ORDER BY date)) as threads_delta
        FROM daily_stats
        ORDER BY date DESC
        LIMIT 7
      format: "table"

    # --- ëª©í‘œ ì§„í–‰ë¥  ---
    - name: "ëª©í‘œ ì§„í–‰ë¥ "
      id: "goal_progress"
      query: |
        SELECT
          goal_name,
          current_value,
          target_value,
          ROUND(current_value * 100.0 / target_value, 1) as progress_pct
        FROM goals
        WHERE active = 1
      format: "progress_bars"

    # --- ìµœê³  ì„±ê³¼ í¬ìŠ¤íŠ¸ ---
    - name: "ì´ë²ˆ ì£¼ ë² ìŠ¤íŠ¸ í¬ìŠ¤íŠ¸"
      id: "top_posts"
      query: |
        SELECT
          platform,
          SUBSTR(content, 1, 50) || '...' as preview,
          likes,
          reposts,
          views,
          (likes + reposts * 2) as engagement_score
        FROM posts
        WHERE posted_at > date('now', '-7 days')
        ORDER BY engagement_score DESC
        LIMIT 5
      format: "list"

    # --- ì‹¤í—˜ í˜„í™© ---
    - name: "ì§„í–‰ ì¤‘ì¸ ì‹¤í—˜"
      id: "experiments"
      source: "state/experiments.yaml"
      path: "running"
      format: "list"

    # --- ê·œì¹™ ë³€ê²½ ---
    - name: "ìµœê·¼ ê·œì¹™ ë³€ê²½"
      id: "rule_changes"
      source: "state/rules.yaml"
      path: "history"
      limit: 5
      format: "list"

  # === í…œí”Œë¦¿ ===
  template: |
    # ğŸ“Š í™œë™ ëŒ€ì‹œë³´ë“œ

    > ìƒì„±: {generated_at}

    ---

    ## ğŸ“… ì˜¤ëŠ˜ ({date})

    | í™œë™ | íšŸìˆ˜ |
    |------|------|
    | í¬ìŠ¤íŒ… | {today.posts} |
    | ì¢‹ì•„ìš” | {today.likes} |
    | íŒ”ë¡œìš° | {today.follows} |
    | ë‹µê¸€ | {today.replies} |
    | ë¦¬í¬ìŠ¤íŠ¸ | {today.reposts} |
    | **í•©ê³„** | **{today.total}** |

    ---

    ## ğŸ“ˆ ì„±ì¥ (7ì¼)

    | ë‚ ì§œ | X íŒ”ë¡œì›Œ | ë³€í™” | Threads íŒ”ë¡œì›Œ | ë³€í™” |
    |------|----------|------|----------------|------|
    {growth_table}

    ---

    ## ğŸ¯ ëª©í‘œ ì§„í–‰ë¥ 

    {goal_progress_bars}

    ---

    ## â­ ì´ë²ˆ ì£¼ ë² ìŠ¤íŠ¸

    {top_posts_list}

    ---

    ## ğŸ§ª ì§„í–‰ ì¤‘ì¸ ì‹¤í—˜

    {experiments_list}

    ---

    ## ğŸ“ ìµœê·¼ ê·œì¹™ ë³€ê²½

    {rule_changes_list}

    ---

    *ìë™ ìƒì„±ë¨ by OpenClaw Framework*

  # === ìŠ¤ì¼€ì¤„ ===
  schedule:
    # ì •ê¸° ìƒì„±
    cron: "0 9,21 * * *"              # ì•„ì¹¨ 9ì‹œ, ì €ë… 9ì‹œ

    # ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
    on_events:
      - "goal_achieved"
      - "experiment_completed"
      - "daily_summary"

  # === ì•Œë¦¼ ===
  notifications:
    telegram:
      enabled: true
      target: "${config.telegram.monitor.chat_id}"

    include_sections:
      - "today_activity"
      - "goal_progress"
      - "top_posts"
