# repost.yaml - 리포스트/리트윗 액션 정의

action:
  id: repost
  name: "리포스트"
  description: "좋은 콘텐츠 리포스트 (리트윗)"
  type: "interact"

  # === 경계 참조 ===
  bounds_ref: "sns.engagement"
  daily_limit_key: "max_reposts_per_day"

  # === 사전 검사 ===
  pre_checks:
    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'repost'
        AND platform = '{channel}'
        AND date(created_at) = date('now')
      condition: "count < ${bounds.sns.engagement.max_reposts_per_day}"
      on_fail: "skip"

    - check: "not_already_reposted"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'repost'
        AND target_id = '{post_id}'
      condition: "count == 0"
      on_fail: "skip"

    # 민감한 콘텐츠 체크
    - validator: "shared/validator/forbidden"
      input: "${post.content}"
      on_match: "skip"

  # === 타겟 선택 ===
  targeting:
    # 리포스트 대상 소스
    sources:
      - source: "feed"
        description: "피드에서 고품질 포스트"
        weight: 0.5

      - source: "followed_accounts"
        description: "팔로우 계정의 포스트"
        weight: 0.3

      - source: "trending"
        description: "트렌딩/인기 포스트"
        weight: 0.2

    # 품질 필터
    quality_filter:
      min_likes: 100
      min_engagement_rate: 0.05
      topics: ["AI", "tech", "startup", "coding", "productivity"]
      exclude_topics: ["politics", "religion", "controversy"]

      # 콘텐츠 품질 점수
      quality_score:
        min: 0.7
        factors:
          - factor: "engagement_rate"
            weight: 0.4
          - factor: "topic_relevance"
            weight: 0.3
          - factor: "author_credibility"
            weight: 0.2
          - factor: "content_quality"
            weight: 0.1

    # 제외 조건
    exclude:
      - "contains_promotion"           # 광고 포함
      - "contains_controversial"       # 논란성
      - "author_bot_pattern"           # 봇 계정
      - "repost_of_repost"            # 리포스트의 리포스트

  # === 실행 단계 ===
  steps:
    - name: "find_candidates"
      action: "query_feed"
      params:
        limit: 50
        filters: "${targeting.sources}"
      output: "candidates"

    - name: "score_candidates"
      action: "calculate_quality"
      input: "${candidates}"
      scoring: "${targeting.quality_filter.quality_score}"
      output: "scored_candidates"

    - name: "select_best"
      action: "filter_and_sort"
      input: "${scored_candidates}"
      conditions:
        min_score: "${targeting.quality_filter.quality_score.min}"
      sort_by: "score desc"
      limit: "${bounds.sns.engagement.max_reposts_per_day}"
      output: "selected_posts"

    - name: "execute_reposts"
      for_each: "post in selected_posts"
      steps:
        - name: "validate_again"
          description: "최종 검증"
          validator: "shared/validator/forbidden"
          input: "${post.content}"
          on_fail: "skip_this"

        - name: "repost"
          script: "${channel.actions.repost.script}"
          params:
            post_id: "${post.id}"
            selector: "${channel.actions.repost.selector}"
          output: "result"

        - name: "record"
          action: "db_insert"
          table: "activity_log"
          data:
            action_type: "repost"
            platform: "${channel.id}"
            target_id: "${post.id}"
            target_author: "${post.author}"
            quality_score: "${post.score}"
            created_at: "now()"

        - action: "wait"
          duration: "300s"             # 5분 간격

  # === 결과 처리 ===
  on_success:
    - log: "Reposted {count} posts on {channel}"
    - metric: "increment reposts_today by {count}"

  on_failure:
    - log: "Repost failed: {error}"

  # === 로깅 ===
  logging:
    log_reposts: true
    log_quality_scores: true
    log_path: "data/engagement_log.json"
