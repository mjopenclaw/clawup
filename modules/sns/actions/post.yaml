# post.yaml - 포스팅 액션 정의

action:
  id: post
  name: "콘텐츠 포스팅"
  description: "SNS 채널에 콘텐츠 포스팅"
  type: "write"                        # write | read | interact

  # === 경계 참조 ===
  bounds_ref: "sns.posting"

  # === 사전 검사 ===
  pre_checks:
    - validator: "shared/validator/similarity"
      on_fail: "rephrase"
      max_retries: 2

    - validator: "shared/validator/forbidden"
      on_fail: "block"

    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM posts
        WHERE platform = '{channel}'
        AND date(posted_at) = date('now')
      condition: "count < ${bounds.sns.posting.max_per_day}"
      on_fail: "skip"
      message: "오늘 일일 포스팅 한도({limit})에 도달했습니다"

    - check: "min_interval"
      query: |
        SELECT MAX(posted_at) as last_post FROM posts
        WHERE platform = '{channel}'
      condition: "now - last_post > ${bounds.sns.posting.min_interval_minutes} * 60"
      on_fail: "delay"
      message: "최소 간격({interval}분) 미충족. 나중에 다시 시도합니다"

  # === 실행 단계 ===
  steps:
    - name: "load_content"
      action: "input"
      source: "queue"                  # queue | direct | generated
      output: "raw_content"

    - name: "adapt_tone"
      service: "shared/tone/{channel.tone_ref}"
      input: "${raw_content}"
      output: "toned_content"

    - name: "adapt_length"
      service: "shared/transformer/adapt-length"
      input: "${toned_content}"
      params:
        target_length: "${channel.content.max_length}"
      output: "final_content"
      on_exceed:
        action: "split_to_thread"

    - name: "validate"
      run_checks: true
      input: "${final_content}"

    - name: "review"
      service: "shared/approval/telegram"
      input: "${final_content}"
      enabled: "${config.require_review}"
      timeout_minutes: 60
      on_timeout: "skip"

    - name: "execute"
      script: "${channel.actions.post.script}"
      input: "${final_content}"
      output: "result"

    - name: "record"
      action: "db_insert"
      table: "posts"
      data:
        platform: "${channel.id}"
        content: "${final_content}"
        posted_at: "now()"
        status: "${result.success ? 'posted' : 'failed'}"
        post_id: "${result.post_id}"

    - name: "notify"
      condition: "${result.success}"
      action: "telegram_send"
      message: "✅ 포스팅 완료: ${channel.name}\n${final_content.substring(0, 50)}..."

  # === 결과 처리 ===
  on_success:
    - log: "Post successful: {post_id}"
    - metric: "increment posts_today"
    - trigger: "post_analytics_check"
      delay_hours: 24

  on_failure:
    - log: "Post failed: {error}"
    - notify: "❌ 포스팅 실패: {channel.name}\n에러: {error}"
    - retry:
        max_attempts: 3
        delay_minutes: 5

  # === 로깅 ===
  logging:
    log_attempts: true
    log_content: true
    log_path: "data/post_log.json"
