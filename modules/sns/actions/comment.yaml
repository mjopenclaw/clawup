# comment.yaml - 댓글 액션 정의

action:
  id: comment
  name: "댓글"
  description: "관련 포스트에 가치있는 댓글 달기 (Reply Guy 전략)"
  type: "write"

  # === 경계 참조 ===
  bounds_ref: "sns.engagement"
  daily_limit_key: "max_comments_per_day"

  # === 사전 검사 ===
  pre_checks:
    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'comment'
        AND platform = '{channel}'
        AND date(created_at) = date('now')
      condition: "count < ${bounds.sns.engagement.max_comments_per_day}"
      on_fail: "skip"

    - check: "not_already_commented"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'comment'
        AND target_id = '{post_id}'
      condition: "count == 0"
      on_fail: "skip"

  # === 타겟 선택 (Reply Guy 전략) ===
  targeting:
    # 큰 계정의 포스트 타겟팅
    strategy: "reply_guy"
    description: "큰 계정에 가치있는 첫 댓글을 달아 노출 얻기"

    # 타겟 계정 조건
    target_accounts:
      min_followers: 10000
      max_followers: 1000000
      topics: ["AI", "tech", "startup", "coding"]
      verified_preferred: true

    # 포스트 조건
    post_filter:
      max_age_minutes: 30              # 최근 30분 내 포스트 (첫 댓글 선점)
      max_existing_replies: 10         # 이미 댓글 많으면 스킵
      topics: ["AI", "tech", "startup"]
      exclude_promotional: true
      exclude_controversial: true

    # 댓글 유형
    comment_types:
      - type: "value_add"
        description: "추가 정보나 인사이트 제공"
        weight: 0.5
        example: "여기에 추가로 ~도 중요한 것 같아요. 경험상..."

      - type: "question"
        description: "좋은 질문으로 대화 유도"
        weight: 0.3
        example: "혹시 ~의 경우에도 적용될까요?"

      - type: "agreement_with_insight"
        description: "공감 + 새로운 관점"
        weight: 0.2
        example: "이 부분 진짜 공감해요. 저도 비슷한 경험에서..."

    # 피해야 할 댓글 유형
    avoid:
      - "단순 동의 (맞아요, 좋아요)"
      - "이모지만"
      - "홍보/광고"
      - "논쟁 유발"

  # === LLM 댓글 생성 ===
  llm_config:
    enabled: true

    prompt_template: |
      다음 포스트에 가치있는 댓글을 작성해줘.

      **원본 포스트:**
      작성자: {post.author} (팔로워 {post.author_followers}명)
      내용: {post.content}

      **댓글 유형:** {comment_type.type}
      **설명:** {comment_type.description}

      **댓글 규칙:**
      - 말투: {tone_ref} (캐주얼하게)
      - 최대 {max_length}자
      - 실제로 가치있는 내용 추가
      - 자연스럽고 인간적으로
      - 논쟁 유발 X
      - 홍보 X

      **좋은 예시:**
      {comment_type.example}

      댓글만 출력 (설명 없이):

  # === 실행 단계 ===
  steps:
    - name: "find_target_posts"
      action: "scan_feed"
      params:
        accounts: "${targeting.target_accounts}"
        filter: "${targeting.post_filter}"
        limit: 20
      output: "candidate_posts"

    - name: "select_posts"
      action: "filter_and_rank"
      input: "${candidate_posts}"
      ranking:
        - factor: "recency"
          weight: 0.4
        - factor: "author_followers"
          weight: 0.3
        - factor: "topic_match"
          weight: 0.3
      limit: 5
      output: "selected_posts"

    - name: "comment_on_posts"
      for_each: "post in selected_posts"
      steps:
        - name: "select_comment_type"
          action: "weighted_random"
          options: "${targeting.comment_types}"
          output: "comment_type"

        - name: "generate_comment"
          action: "llm_generate"
          prompt: "${llm_config.prompt_template}"
          params:
            post: "${post}"
            comment_type: "${comment_type}"
            tone_ref: "${channel.actions.comment.tone_ref}"
            max_length: "${channel.content.max_length}"
          output: "comment_content"

        - name: "validate_comment"
          validator: "shared/validator/forbidden"
          input: "${comment_content}"
          on_fail: "regenerate"
          max_retries: 2

        - name: "post_comment"
          script: "${channel.actions.comment.script}"
          params:
            post_id: "${post.id}"
            content: "${comment_content}"
          output: "result"

        - name: "record"
          action: "db_insert"
          table: "activity_log"
          data:
            action_type: "comment"
            platform: "${channel.id}"
            target_id: "${post.id}"
            target_author: "${post.author}"
            content: "${comment_content}"
            comment_type: "${comment_type.type}"
            created_at: "now()"

        - action: "wait"
          duration: "600s"             # 10분 간격

  # === 결과 처리 ===
  on_success:
    - log: "Commented on {count} posts on {channel}"
    - metric: "increment comments_today by {count}"

  # === 로깅 ===
  logging:
    log_comments: true
    log_generated_content: true
    log_path: "data/comment_log.json"
