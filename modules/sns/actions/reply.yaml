# reply.yaml - 답글 액션 정의

action:
  id: reply
  name: "답글"
  description: "멘션/댓글에 답글 달기 (LLM 사용)"
  type: "write"

  # === 경계 참조 ===
  bounds_ref: "sns.engagement"
  daily_limit_key: "max_comments_per_day"

  # === 사전 검사 ===
  pre_checks:
    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'reply'
        AND platform = '{channel}'
        AND date(created_at) = date('now')
      condition: "count < ${bounds.sns.engagement.max_comments_per_day}"
      on_fail: "skip"

    - check: "not_already_replied"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'reply'
        AND target_id = '{mention_id}'
      condition: "count == 0"
      on_fail: "skip"

    # 금지어 포함 멘션은 스킵
    - validator: "shared/validator/forbidden"
      input: "${mention.content}"
      on_match: "skip"

  # === 타겟 선택 ===
  targeting:
    # 답글 대상
    sources:
      - source: "mentions"
        description: "직접 멘션"
        priority: "high"
        filter:
          not_spam: true
          not_bot: true

      - source: "replies_to_my_posts"
        description: "내 포스트에 달린 댓글"
        priority: "high"

      - source: "questions"
        description: "질문 형태의 멘션"
        priority: "medium"
        filter:
          contains: ["?", "어떻게", "뭐", "왜", "어디"]

    # 스킵 조건
    skip_if:
      - "spam_keywords"                # 스팸 키워드 포함
      - "bot_pattern"                  # 봇 패턴
      - "troll_pattern"                # 트롤 패턴 (논쟁 유도)

  # === LLM 답글 생성 ===
  llm_config:
    enabled: true
    model: "default"                   # OpenClaw 기본 모델 사용

    prompt_template: |
      다음 멘션에 답글을 작성해줘.

      **원본 멘션:**
      작성자: {mention.author}
      내용: {mention.content}

      **컨텍스트:**
      - 이전 대화: {conversation_context}
      - 내 원래 포스트: {original_post}

      **답글 규칙:**
      - 말투: {tone_ref}의 규칙 따르기
      - 최대 {max_length}자
      - 자연스럽고 인간적으로
      - 도움이 되는 내용으로
      - 질문이면 정확히 답변
      - 공격적 멘션이면 정중하게 대응하거나 무시

      **절대 금지:**
      - 정치/종교 관련 답변
      - 논쟁 유도
      - 공격적 표현

      답글만 출력 (설명 없이):

    # 답글 스타일별 프롬프트 변형
    style_variants:
      helpful:
        suffix: "도움이 되는 정보나 조언 제공"
      witty:
        suffix: "재치있고 유머러스하게"
      brief:
        suffix: "짧고 간결하게"
      question:
        suffix: "대화를 이어갈 수 있는 질문으로 마무리"

  # === 실행 단계 ===
  steps:
    - name: "get_mentions"
      action: "query"
      sql: |
        SELECT * FROM notifications
        WHERE type IN ('mention', 'reply')
        AND platform = '{channel}'
        AND replied = 0
        AND created_at > date('now', '-24 hours')
        ORDER BY created_at DESC
        LIMIT 20
      output: "mentions"

    - name: "filter_mentions"
      action: "filter"
      input: "${mentions}"
      conditions: "${targeting}"
      output: "valid_mentions"

    - name: "process_mentions"
      for_each: "mention in valid_mentions"
      max_iterations: 10
      steps:
        - name: "get_context"
          action: "query"
          sql: |
            SELECT content FROM posts
            WHERE post_id = '{mention.in_reply_to}'
          output: "context"

        - name: "generate_reply"
          action: "llm_generate"
          prompt: "${llm_config.prompt_template}"
          params:
            mention: "${mention}"
            conversation_context: "${context}"
            tone_ref: "${channel.actions.reply.tone_ref}"
            max_length: "${channel.actions.reply.max_length}"
          output: "reply_content"

        - name: "validate_reply"
          validator: "shared/validator/forbidden"
          input: "${reply_content}"
          on_fail: "regenerate"
          max_retries: 2

        - name: "post_reply"
          script: "${channel.actions.reply.script}"
          params:
            in_reply_to: "${mention.id}"
            content: "${reply_content}"
          output: "result"

        - name: "record"
          action: "db_insert"
          table: "activity_log"
          data:
            action_type: "reply"
            platform: "${channel.id}"
            target_id: "${mention.id}"
            target_author: "${mention.author}"
            content: "${reply_content}"
            created_at: "now()"

        - name: "mark_as_replied"
          action: "db_update"
          table: "notifications"
          where: "id = '${mention.id}'"
          set:
            replied: 1
            replied_at: "now()"

        - action: "wait"
          duration: "${state.rules.engagement.reply.delay_minutes * 60}s"

  # === 결과 처리 ===
  on_success:
    - log: "Replied to {count} mentions on {channel}"
    - metric: "increment replies_today by {count}"

  on_failure:
    - log: "Reply failed: {error}"

  # === 로깅 ===
  logging:
    log_replies: true
    log_generated_content: true
    log_path: "data/reply_log.json"
