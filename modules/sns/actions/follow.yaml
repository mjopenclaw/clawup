# follow.yaml - 팔로우 액션 정의

action:
  id: follow
  name: "팔로우"
  description: "관심 있는 계정 팔로우"
  type: "interact"

  # === 경계 참조 ===
  bounds_ref: "sns.engagement"
  daily_limit_key: "max_follows_per_day"

  # === 사전 검사 ===
  pre_checks:
    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'follow'
        AND platform = '{channel}'
        AND date(created_at) = date('now')
      condition: "count < ${bounds.sns.engagement.max_follows_per_day}"
      on_fail: "skip"

    - check: "not_already_following"
      query: |
        SELECT COUNT(*) as count FROM following
        WHERE platform = '{channel}'
        AND target_handle = '{handle}'
      condition: "count == 0"
      on_fail: "skip"

    - check: "not_recently_unfollowed"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type = 'unfollow'
        AND platform = '{channel}'
        AND target_handle = '{handle}'
        AND created_at > date('now', '-30 days')
      condition: "count == 0"
      on_fail: "skip"
      message: "최근 언팔로우한 계정입니다"

  # === 타겟 선택 ===
  targeting:
    # 타겟 소스
    sources:
      - source: "suggested"
        description: "플랫폼 추천 계정"
        weight: 0.3

      - source: "followers_of"
        description: "큰 계정의 팔로워"
        target_accounts: ["@openai", "@anthropic"]
        weight: 0.3

      - source: "engaging_with"
        description: "내 콘텐츠에 반응한 계정"
        weight: 0.4

    # 필터 조건
    filter:
      min_followers: 10
      max_followers: 50000
      min_following_ratio: 0.1        # 팔로워/팔로잉 비율
      has_profile_image: true
      has_bio: true
      not_bot: true                    # 봇 패턴 제외
      language: "ko"

    # 봇 감지 패턴
    bot_patterns:
      - "followers < 10 AND following > 1000"
      - "no_posts AND following > 500"
      - "username_pattern: '^[a-z]+\\d{5,}$'"  # abcde12345 패턴

  # === 실행 단계 ===
  steps:
    - name: "select_targets"
      action: "query_targets"
      params:
        limit: "${bounds.sns.engagement.max_follows_per_day}"
        filters: "${targeting}"
      output: "targets"

    - name: "execute_follows"
      for_each: "target in targets"
      steps:
        - action: "browser_click"
          script: "${channel.actions.follow.script}"
          params:
            handle: "${target.handle}"
            selector: "${channel.actions.follow.selector}"

        - action: "record_activity"
          table: "activity_log"
          data:
            action_type: "follow"
            platform: "${channel.id}"
            target_handle: "${target.handle}"
            target_followers: "${target.followers}"
            created_at: "now()"

        - action: "record_following"
          table: "following"
          data:
            platform: "${channel.id}"
            target_handle: "${target.handle}"
            followed_at: "now()"

        - action: "wait"
          duration: "${channel.actions.follow.cooldown_minutes * 60}s"

  # === 결과 처리 ===
  on_success:
    - log: "Followed {count} accounts on {channel}"
    - metric: "increment follows_today by {count}"

  on_failure:
    - log: "Follow failed: {error}"

  # === 로깅 ===
  logging:
    log_follows: true
    log_path: "data/engagement_log.json"
