# follow-back.yaml - ë§íŒ”ë¡œìš° ì•¡ì…˜ ì •ì˜

action:
  id: follow_back
  name: "ë§íŒ”ë¡œìš°"
  description: "ìƒˆ íŒ”ë¡œì›Œ ì¤‘ ì¡°ê±´ ë§ëŠ” ê³„ì • ë§íŒ”ë¡œìš°"
  type: "interact"

  # === ê²½ê³„ ì°¸ì¡° ===
  bounds_ref: "sns.engagement"
  daily_limit_key: "max_follows_per_day"

  # === ì‚¬ì „ ê²€ì‚¬ ===
  pre_checks:
    - check: "daily_limit"
      query: |
        SELECT COUNT(*) as count FROM activity_log
        WHERE action_type IN ('follow', 'follow_back')
        AND platform = '{channel}'
        AND date(created_at) = date('now')
      condition: "count < ${bounds.sns.engagement.max_follows_per_day}"
      on_fail: "skip"

  # === íƒ€ê²Ÿ ì„ íƒ ===
  targeting:
    # ìƒˆ íŒ”ë¡œì›Œ ì¤‘ì—ì„œ ì„ íƒ
    source: "new_followers"
    query: |
      SELECT DISTINCT n.actor_handle, n.actor_followers, n.created_at
      FROM notifications n
      LEFT JOIN following f ON n.actor_handle = f.target_handle AND f.platform = '{channel}'
      WHERE n.type = 'follow'
      AND n.platform = '{channel}'
      AND f.target_handle IS NULL  -- ì•„ì§ íŒ”ë¡œìš°í•˜ì§€ ì•Šì€ ê³„ì •
      AND n.created_at > date('now', '-7 days')
      ORDER BY n.created_at DESC

    # í•„í„° ì¡°ê±´
    filter:
      min_followers: 10
      max_followers: 100000
      min_posts: 5
      has_profile_image: true
      not_bot: true

    # ìŠ¤íŒ¸/ë´‡ ì œì™¸ íŒ¨í„´
    exclude_patterns:
      - "bio contains 'íŒ”ë¡œìš°í•˜ë©´ íŒ”ë¡œìš°'"
      - "bio contains 'follow for follow'"
      - "username matches '^[a-z]+\\d{6,}$'"
      - "followers < 10 AND following > 1000"
      - "no_posts_in_30_days"

  # === ì‹¤í–‰ ë‹¨ê³„ ===
  steps:
    - name: "get_new_followers"
      action: "query"
      sql: "${targeting.query}"
      params:
        channel: "${channel.id}"
      output: "new_followers"

    - name: "filter_followers"
      action: "filter"
      input: "${new_followers}"
      conditions: "${targeting.filter}"
      exclude: "${targeting.exclude_patterns}"
      output: "qualified_followers"

    - name: "apply_delay"
      description: "ì¦‰ì‹œ ë§íŒ”ë¡œìš°í•˜ë©´ ë´‡ì²˜ëŸ¼ ë³´ì„"
      filter: |
        created_at < now() - interval '${channel.actions.follow_back.delay_minutes} minutes'
      output: "delayed_followers"

    - name: "execute_follow_backs"
      for_each: "follower in delayed_followers"
      max_iterations: "${bounds.sns.engagement.max_follows_per_day}"
      steps:
        - action: "browser_click"
          script: "${channel.actions.follow.script}"
          params:
            handle: "${follower.actor_handle}"

        - action: "record_activity"
          table: "activity_log"
          data:
            action_type: "follow_back"
            platform: "${channel.id}"
            target_handle: "${follower.actor_handle}"
            created_at: "now()"

        - action: "record_following"
          table: "following"
          data:
            platform: "${channel.id}"
            target_handle: "${follower.actor_handle}"
            followed_at: "now()"
            is_follow_back: true

        - action: "wait"
          duration: "${channel.actions.follow_back.cooldown_minutes * 60}s"

  # === ê²°ê³¼ ì²˜ë¦¬ ===
  on_success:
    - log: "Followed back {count} accounts on {channel}"
    - metric: "increment follow_backs_today by {count}"
    - notify: "ğŸ‘¥ ë§íŒ”ë¡œìš° ì™„ë£Œ: {count}ëª…"

  on_failure:
    - log: "Follow back failed: {error}"

  # === ë¡œê¹… ===
  logging:
    log_follow_backs: true
    log_path: "data/engagement_log.json"
