# daily-check.yaml - ìˆ˜ìµì› ì¼ì¼ ê±´ê°• ì²´í¬
# í™œì„±í™”ëœ ìˆ˜ìµì›ë“¤ì˜ ìƒíƒœë¥¼ ë§¤ì¼ í™•ì¸

health_check:
  id: daily-income-check
  name: "ì¼ì¼ ìˆ˜ìµ ê±´ê°• ì²´í¬"
  description: "ëª¨ë“  í™œì„± ìˆ˜ìµì›ì˜ ìƒíƒœ í™•ì¸ ë° ì´ìƒ ê°ì§€"

  # === ìŠ¤ì¼€ì¤„ ===
  schedule:
    cron: "0 9 * * *"                  # ë§¤ì¼ ì˜¤ì „ 9ì‹œ
    timezone: "Asia/Seoul"
    enabled: true

  # === ì²´í¬ í•­ëª© ===
  checks:
    # 1. ê³„ì • ìƒíƒœ ì²´í¬
    - id: "account_status"
      name: "ê³„ì • ìƒíƒœ"
      description: "ê° ìˆ˜ìµì› ê³„ì •ì´ ì •ìƒ ìƒíƒœì¸ì§€ í™•ì¸"
      for_each: "source in active_sources"

      steps:
        - action: "api_check"
          condition: "source.has_api"
          endpoint: "${source.monitoring.health_check.checks[0].endpoint}"
          expected: "status == 'active'"

        - action: "browser_check"
          condition: "source.auth.method == 'browser'"
          url: "${source.dashboard_url}"
          check: "logged_in AND no_warnings"

      on_fail:
        severity: "high"
        alert: true
        message: "âš ï¸ ${source.name} ê³„ì • ì´ìƒ ê°ì§€"

    # 2. ìˆ˜ìµ ì¶”ì´ ì²´í¬
    - id: "earnings_trend"
      name: "ìˆ˜ìµ ì¶”ì´"
      description: "ìˆ˜ìµì´ ì •ìƒ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸"

      query: |
        SELECT
          source_id,
          SUM(amount) as current_week,
          (SELECT SUM(amount) FROM income_log
           WHERE source_id = i.source_id
           AND date BETWEEN date('now', '-14 days') AND date('now', '-7 days')
          ) as previous_week
        FROM income_log i
        WHERE date >= date('now', '-7 days')
        GROUP BY source_id

      evaluate:
        # 20% ì´ìƒ í•˜ë½ ì‹œ ê²½ê³ 
        - condition: "current_week < previous_week * 0.8"
          severity: "medium"
          message: "ğŸ“‰ ${source.name} ìˆ˜ìµ ${drop_percent}% ê°ì†Œ"

        # 50% ì´ìƒ í•˜ë½ ì‹œ ì‹¬ê°
        - condition: "current_week < previous_week * 0.5"
          severity: "high"
          message: "ğŸš¨ ${source.name} ìˆ˜ìµ ê¸‰ê°! í™•ì¸ í•„ìš”"

        # ìˆ˜ìµ ì¦ê°€ ì‹œ ì¢‹ì€ ì†Œì‹
        - condition: "current_week > previous_week * 1.2"
          severity: "info"
          message: "ğŸ“ˆ ${source.name} ìˆ˜ìµ ${increase_percent}% ì¦ê°€!"

    # 3. í™œë™ ì²´í¬
    - id: "activity_check"
      name: "í™œë™ ìƒíƒœ"
      description: "í•„ìš”í•œ í™œë™ì´ ìˆ˜í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸"

      query: |
        SELECT
          source_id,
          COUNT(*) as activity_count,
          MAX(created_at) as last_activity
        FROM income_activity
        WHERE date >= date('now', '-7 days')
        GROUP BY source_id

      evaluate:
        # í™œë™ ì—†ìŒ ê²½ê³ 
        - condition: "activity_count == 0 AND source.requires_activity"
          severity: "medium"
          message: "âš ï¸ ${source.name}: ì§€ë‚œ 7ì¼ê°„ í™œë™ ì—†ìŒ"

        # ì˜¤ë˜ëœ ë§ˆì§€ë§‰ í™œë™
        - condition: "last_activity < date('now', '-3 days')"
          severity: "low"
          message: "â„¹ï¸ ${source.name}: ë§ˆì§€ë§‰ í™œë™ 3ì¼ ì „"

    # 4. ì§€ê¸‰ ìƒíƒœ ì²´í¬
    - id: "payment_status"
      name: "ì§€ê¸‰ ìƒíƒœ"
      description: "ì˜ˆì •ëœ ì§€ê¸‰ì´ ì •ìƒì ìœ¼ë¡œ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ í™•ì¸"

      query: |
        SELECT * FROM expected_payments
        WHERE expected_date <= date('now')
        AND status = 'pending'

      evaluate:
        - condition: "count > 0"
          severity: "medium"
          message: "ğŸ’³ ë¯¸ìˆ˜ë ¹ ì§€ê¸‰ ${count}ê±´ í™•ì¸ í•„ìš”"

    # 5. ì—ëŸ¬/ê²½ê³  ì²´í¬
    - id: "error_check"
      name: "ì—ëŸ¬ í™•ì¸"
      description: "ê° ìˆ˜ìµì›ì˜ ì—ëŸ¬/ê²½ê³  ë¡œê·¸ í™•ì¸"

      query: |
        SELECT
          source_id,
          COUNT(*) as error_count,
          GROUP_CONCAT(DISTINCT error_type) as error_types
        FROM income_errors
        WHERE date >= date('now', '-1 day')
        GROUP BY source_id

      evaluate:
        - condition: "error_count > 0"
          severity: "medium"
          message: "âš ï¸ ${source.name}: ${error_count}ê°œ ì—ëŸ¬ ë°œìƒ"

  # === ë³´ê³ ì„œ ìƒì„± ===
  report:
    template: |
      # ğŸ’° ì¼ì¼ ìˆ˜ìµ ê±´ê°• ì²´í¬

      > ì²´í¬ ì‹œê°„: {check_time}

      ## ğŸ“Š ìš”ì•½

      | ìˆ˜ìµì› | ìƒíƒœ | ì´ë²ˆ ì£¼ ìˆ˜ìµ | ë³€í™” |
      |--------|------|--------------|------|
      {source_summary_table}

      ## âš ï¸ ì£¼ì˜ ì‚¬í•­

      {warnings}

      ## âœ… ì •ìƒ í•­ëª©

      {healthy_items}

      ## ğŸ“‹ ê¶Œì¥ ì¡°ì¹˜

      {recommended_actions}

    output:
      - type: "db"
        table: "health_check_log"
      - type: "telegram"
        condition: "has_warnings OR is_monday"
        send_to: "${config.telegram.monitor.chat_id}"

  # === ì•Œë¦¼ ì„¤ì • ===
  alerts:
    telegram:
      enabled: true
      severity_threshold: "medium"     # low, medium, high

    conditions:
      # í•­ìƒ ì•Œë¦¼
      always_alert:
        - "account_suspended"
        - "payment_failed"
        - "earnings_drop > 50%"

      # ì§‘ê³„ ì•Œë¦¼ (ì¼ì¼ ìš”ì•½ì— í¬í•¨)
      batch_alert:
        - "earnings_drop 20-50%"
        - "minor_warnings"

  # === ìë™ ë³µêµ¬ ===
  auto_recovery:
    enabled: true

    actions:
      - condition: "session_expired"
        action: "refresh_session"
        notify: true

      - condition: "api_rate_limited"
        action: "pause_and_retry"
        delay_minutes: 60

  # === ë¡œê¹… ===
  logging:
    log_checks: true
    log_path: "data/health_check_log.json"
    retain_days: 30
