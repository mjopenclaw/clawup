name: post-content
description: 콘텐츠 큐에서 가져와 X+Threads에 포스팅
enabled: true

preconditions:
  - type: sql
    query: "SELECT COUNT(*) as cnt FROM content_queue WHERE posted=0"
    expect: "cnt > 0"
  - type: sql
    query: "SELECT COUNT(*) as cnt FROM posts WHERE date(created_at)=date('now')"
    expect: "cnt < 99"  # 테스트용, 나중에 6으로 복구

steps:
  - name: get-content
    type: sql
    query: "SELECT id, content FROM content_queue WHERE posted=0 ORDER BY id ASC LIMIT 1"
    output: content

  - name: check-duplicate
    type: module
    module: similarity.check
    args: ["${content.content}"]
    on_fail: skip

  - name: post-x
    type: module
    module: browser.post_x
    args: ["${content.content}"]

  - name: post-threads
    type: module
    module: browser.post_threads
    args: ["${content.content}"]

  - name: mark-posted
    type: sql
    query: "UPDATE content_queue SET posted=1 WHERE id=${content.id}"

on_success:
  - type: sql
    query: "INSERT INTO posts (platform, content, created_at) VALUES ('x', '${content.content}', datetime('now'))"
  - type: notify
    message: "✅ 포스팅 완료: ${content.content}"

on_failure:
  - type: log
    message: "❌ 포스팅 실패: ${error}"
