# Posting Executor - Goal-Driven Cron
# Queueì—ì„œ ì½˜í…ì¸ ë¥¼ êº¼ë‚´ X + Threadsì— í¬ìŠ¤íŒ…

cron:
  id: "posting-executor"
  schedule: "*/15 * * * *"  # 15ë¶„ë§ˆë‹¤
  max_duration_minutes: 50

goal:
  id: "daily_posts"
  target: 3  # í•˜ë£¨ 3ê°œ í¬ìŠ¤íŒ…
  metric: |
    SELECT COUNT(*) FROM posts 
    WHERE date(created_at) = date('now') 
    AND platform IN ('x', 'threads')

phases:
  plan:
    checks:
      - name: "queue_check"
        query: "SELECT COUNT(*) FROM content_queue WHERE posted = 0"
        min_value: 1
        fail_message: "Queueê°€ ë¹„ì–´ìˆìŒ"
      
      - name: "daily_limit"
        query: |
          SELECT COUNT(*) FROM posts 
          WHERE date(created_at) = date('now')
        max_value: 6
        fail_message: "ì¼ì¼ í•œë„ ë„ë‹¬"
      
      - name: "rate_limit"
        query: |
          SELECT COUNT(*) FROM posts 
          WHERE created_at > datetime('now', '-1 hour')
        max_value: 2
        fail_message: "ì‹œê°„ë‹¹ í•œë„ ë„ë‹¬"

  research:
    enabled: true
    strategy_selection: |
      -- ìµœê·¼ 7ì¼ ê°€ì¥ ì„±ê³¼ ì¢‹ì€ topic ì„ íƒ
      SELECT topic, AVG(engagement_rate) as avg_eng
      FROM post_analytics
      WHERE posted_at > date('now', '-7 days')
      GROUP BY topic
      ORDER BY avg_eng DESC
      LIMIT 1
    
    timing_check: |
      -- í˜„ì¬ ì‹œê°„ì´ ìµœì  ì‹œê°„ì¸ì§€
      SELECT CASE 
        WHEN strftime('%H', 'now', 'localtime') BETWEEN '09' AND '11' THEN 'optimal'
        WHEN strftime('%H', 'now', 'localtime') BETWEEN '19' AND '23' THEN 'optimal'
        ELSE 'acceptable'
      END as timing

  execute:
    steps:
      - name: "select_content"
        action: "db_query"
        query: |
          SELECT id, content, platform 
          FROM content_queue 
          WHERE posted = 0 
          ORDER BY 
            CASE WHEN source = 'research' THEN 1 ELSE 2 END,
            created_at ASC
          LIMIT 1
      
      - name: "post_to_x"
        action: "browser_automation"
        platform: "x"
        requires: "select_content.content"
      
      - name: "post_to_threads"
        action: "browser_automation"
        platform: "threads"
        requires: "select_content.content"
      
      - name: "mark_posted"
        action: "db_update"
        query: "UPDATE content_queue SET posted = 1 WHERE id = ?"
        params: ["select_content.id"]
      
      - name: "record_post"
        action: "db_insert"
        table: "posts"
        data:
          platform: "x"
          content: "select_content.content"

  feedback:
    measure_after_minutes: 10
    actions:
      - name: "collect_metrics"
        description: "í¬ìŠ¤íŠ¸ ì„±ê³¼ ìˆ˜ì§‘ (likes, replies, views)"
      
      - name: "update_analytics"
        query: |
          INSERT INTO post_analytics (platform, content_type, posted_at, likes)
          VALUES (?, 'text', datetime('now'), ?)
      
      - name: "notify"
        channel: "telegram"
        template: "âœ… í¬ìŠ¤íŒ… ì™„ë£Œ: {platform} - {likes} likes"

  retry:
    max_attempts: 3
    backoff_minutes: [5, 15, 30]
    on_failure:
      - "log_error"
      - "notify_failure"
      - "try_alternative_strategy"

notifications:
  on_success:
    channel: "telegram"
    bot: "monitor"
    message: "ğŸ“ í¬ìŠ¤íŒ… ì™„ë£Œ"
  
  on_failure:
    channel: "telegram"
    bot: "monitor"
    message: "âŒ í¬ìŠ¤íŒ… ì‹¤íŒ¨: {error}"
