# Strategy Analyzer - Goal-Driven Cron
# Îç∞Ïù¥ÌÑ∞ Í∏∞Î∞òÏúºÎ°ú ÏµúÏ†Å Ï†ÑÎûµ ÎèÑÏ∂ú ‚Üí self_improvement_rules ÏóÖÎç∞Ïù¥Ìä∏

cron:
  id: "strategy-analyzer"
  schedule: "0 */4 * * *"  # 4ÏãúÍ∞ÑÎßàÎã§
  max_duration_minutes: 45

goal:
  id: "strategy_optimization"
  target: 1  # Ìï≠ÏÉÅ ÏµúÏ†ÅÌôîÎêú Ï†ÑÎûµ Ïú†ÏßÄ
  metric: |
    SELECT COUNT(*) FROM self_improvement_rules 
    WHERE validated_at > datetime('now', '-7 days')

phases:
  plan:
    checks:
      - name: "enough_data"
        query: "SELECT COUNT(*) FROM post_analytics WHERE posted_at > date('now', '-7 days')"
        min_value: 5
        fail_message: "Î∂ÑÏÑùÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä Î∂ÄÏ°±Ìï® (ÏµúÏÜå 5Í∞ú ÌïÑÏöî)"

  research:
    enabled: true
    analyses:
      - name: "best_posting_time"
        query: |
          SELECT 
            strftime('%H', posted_at) as hour,
            AVG(likes + replies + retweets) as avg_engagement
          FROM post_analytics
          WHERE posted_at > date('now', '-30 days')
          GROUP BY hour
          HAVING COUNT(*) >= 2
          ORDER BY avg_engagement DESC
          LIMIT 3
        output: "optimal_hours"
      
      - name: "best_topic"
        query: |
          SELECT 
            topic,
            AVG(engagement_rate) as avg_rate,
            COUNT(*) as post_count
          FROM post_analytics
          WHERE posted_at > date('now', '-14 days')
          GROUP BY topic
          HAVING post_count >= 2
          ORDER BY avg_rate DESC
          LIMIT 3
        output: "optimal_topics"
      
      - name: "content_length_impact"
        query: |
          SELECT 
            CASE 
              WHEN content_length < 100 THEN 'short'
              WHEN content_length < 200 THEN 'medium'
              ELSE 'long'
            END as length_category,
            AVG(engagement_rate) as avg_rate
          FROM post_analytics
          WHERE posted_at > date('now', '-14 days')
          GROUP BY length_category
          ORDER BY avg_rate DESC
        output: "optimal_length"

  execute:
    steps:
      - name: "generate_rules"
        action: "ai_analysis"
        prompt: |
          Î∂ÑÏÑù Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú Í∑úÏπô ÏÉùÏÑ±:
          - ÏµúÏ†Å ÏãúÍ∞Ñ: {optimal_hours}
          - ÏµúÏ†Å Ï£ºÏ†ú: {optimal_topics}
          - ÏµúÏ†Å Í∏∏Ïù¥: {optimal_length}
          
          SQL INSERT Î¨∏ÏúºÎ°ú Î≥ÄÌôòÌï¥Ï§ò.
      
      - name: "insert_rules"
        action: "db_execute"
        query: |
          INSERT OR REPLACE INTO self_improvement_rules 
          (category, rule, confidence, source, validated_at)
          VALUES 
          ('timing', ?, 0.7, 'auto_analysis', datetime('now')),
          ('content', ?, 0.7, 'auto_analysis', datetime('now'))
      
      - name: "archive_old_rules"
        action: "db_update"
        query: |
          UPDATE self_improvement_rules 
          SET active = 0 
          WHERE validated_at < datetime('now', '-30 days')

  feedback:
    measure_after_minutes: 0
    actions:
      - name: "count_active_rules"
        query: "SELECT COUNT(*) FROM self_improvement_rules WHERE active = 1"
      
      - name: "report"
        action: "log"
        template: "Ï†ÑÎûµ Î∂ÑÏÑù ÏôÑÎ£å: {count_active_rules} ÌôúÏÑ± Í∑úÏπô"

  retry:
    max_attempts: 1  # Î∂ÑÏÑùÏùÄ Ïû¨ÏãúÎèÑ Î∂àÌïÑÏöî
    on_failure:
      - "log_error"

notifications:
  on_success:
    channel: "telegram"
    bot: "monitor"
    message: "üß† Ï†ÑÎûµ Î∂ÑÏÑù ÏôÑÎ£å - {new_rules_count} ÏÉà Í∑úÏπô Ï∂îÍ∞Ä"
