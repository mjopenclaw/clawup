# Metrics Collector - Goal-Driven Cron
# SNS ë©”íŠ¸ë¦­ ìˆ˜ì§‘ â†’ DB ì €ìž¥ â†’ ì˜ì‚¬ê²°ì • ë°ì´í„° ì œê³µ

cron:
  id: "metrics-collector"
  schedule: "*/30 * * * *"  # 30ë¶„ë§ˆë‹¤
  max_duration_minutes: 25

goal:
  id: "data_freshness"
  target: 1  # í•­ìƒ ìµœì‹  ë°ì´í„° ìœ ì§€
  metric: |
    SELECT CASE 
      WHEN MAX(date) >= date('now') THEN 1 
      ELSE 0 
    END 
    FROM daily_stats

phases:
  plan:
    checks:
      - name: "last_collection"
        query: |
          SELECT julianday('now') - julianday(MAX(date)) as days_old
          FROM daily_stats
        max_value: 0.1  # 2.4ì‹œê°„ ì´ìƒ ì§€ë‚¬ìœ¼ë©´ ìˆ˜ì§‘
        fail_message: "ë°ì´í„°ê°€ ì•„ì§ ìµœì‹ ìž„"

  research:
    enabled: false  # ë‹¨ìˆœ ìˆ˜ì§‘ì´ë¼ ë¦¬ì„œì¹˜ ë¶ˆí•„ìš”

  execute:
    steps:
      - name: "collect_x_followers"
        action: "browser_scrape"
        platform: "x"
        target: "profile"
        extract: "followers_count"
      
      - name: "collect_threads_followers"
        action: "browser_scrape"
        platform: "threads"
        target: "profile"
        extract: "followers_count"
      
      - name: "collect_post_metrics"
        action: "browser_scrape"
        platform: "x"
        target: "recent_posts"
        extract: ["likes", "replies", "retweets", "views"]
      
      - name: "update_daily_stats"
        action: "db_upsert"
        table: "daily_stats"
        key: "date"
        data:
          date: "date('now')"
          x_followers: "collect_x_followers.value"
          threads_followers: "collect_threads_followers.value"
      
      - name: "update_goal_progress"
        action: "db_insert"
        table: "goal_progress"
        data:
          goal_id: "x_followers"
          current_value: "collect_x_followers.value"
          target_value: 1000
          progress_pct: "(collect_x_followers.value / 1000) * 100"

  feedback:
    measure_after_minutes: 0  # ì¦‰ì‹œ
    actions:
      - name: "check_growth"
        query: |
          SELECT 
            x_followers - LAG(x_followers) OVER (ORDER BY date) as growth
          FROM daily_stats
          ORDER BY date DESC
          LIMIT 1
      
      - name: "alert_if_significant"
        condition: "growth > 10 OR growth < -5"
        action: "notify"
        template: "ðŸ“Š íŒ”ë¡œì›Œ ë³€ë™: {growth}"

  retry:
    max_attempts: 2
    backoff_minutes: [10, 30]
    on_failure:
      - "log_error"
      - "skip_until_next_schedule"

notifications:
  on_success:
    channel: "telegram"
    bot: "monitor"
    message: "ðŸ“Š ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì™„ë£Œ - X: {x_followers}, Threads: {threads_followers}"
  
  on_failure:
    channel: "telegram"
    bot: "monitor"
    message: "âš ï¸ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹¤íŒ¨"
